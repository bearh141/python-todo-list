<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}Flask App{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col">
    <nav
      class="bg-white shadow-sm px-6 py-3 flex justify-between items-center sticky top-0 z-50"
    >
      <a
        href="{{ url_for('index') }}"
        class="text-xl font-bold text-indigo-600 hover:text-indigo-700 transition"
      >
        <i class="fa-solid fa-list-check mr-2"></i> To-Do App
      </a>

      <div class="flex items-center space-x-4">
        {% if session.get("user_id") %}
        <div class="relative inline-block text-left">
          <button
            id="avatarBtn"
            class="flex items-center space-x-2 focus:outline-none hover:opacity-90 transition"
          >
            <img
              src="https://ui-avatars.com/api/?name={{ session.get('username') }}&background=4f46e5&color=fff"
              alt="avatar"
              class="w-9 h-9 rounded-full border shadow-sm"
            />
          </button>

          <div
            id="dropdownMenu"
            class="hidden absolute right-0 w-52 mt-2 bg-white border rounded-lg shadow-lg z-50 divide-y"
          >
            <div class="py-2">
              <a
                href="{{ url_for('profile.view_profile') }}"
                class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition"
              >
                <i class="fa-solid fa-user mr-2 text-indigo-500"></i> Profile
              </a>

              {% if session.get("is_admin") %}
              <a
                href="{{ url_for('admin.admin_dashboard') }}"
                class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition"
              >
                <i class="fa-solid fa-gauge-high mr-2 text-green-500"></i> Admin
                Dashboard
              </a>
              {% endif %}

              <a
                href="{{ url_for('auth.logout') }}"
                class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 transition"
              >
                <i class="fa-solid fa-right-from-bracket mr-2 text-red-500"></i>
                Đăng xuất
              </a>
            </div>
          </div>
        </div>
        {% else %}
        <a
          href="{{ url_for('auth.login') }}"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 hover:border-indigo-500 hover:text-indigo-600 transition"
        >
          <i class="fa-solid fa-right-to-bracket mr-2 text-indigo-500"></i> Đăng
          nhập
        </a>

        <a
          href="{{ url_for('auth.register') }}"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-lg shadow-sm hover:bg-indigo-700 transition ml-2"
        >
          <i class="fa-solid fa-user-plus mr-2 text-white"></i> Đăng ký
        </a>

        {% endif %}
      </div>
    </nav>

    <main class="flex-1 container mx-auto p-6">
      {% block content %}{% endblock %}
    </main>

    <footer
      class="bg-white shadow-inner py-4 text-center text-sm text-gray-500"
    >
      <p>&copy; {{ now.year }} To-Do App. Built with Flask & TailwindCSS.</p>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("avatarBtn");
        const menu = document.getElementById("dropdownMenu");
        if (btn) {
          btn.addEventListener("click", () => {
            menu.classList.toggle("hidden");
          });
          document.addEventListener("click", (e) => {
            if (!btn.contains(e.target) && !menu.contains(e.target)) {
              menu.classList.add("hidden");
            }
          });
        }

        document.querySelectorAll('.toggle-task').forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            const taskId = checkbox.getAttribute('data-task-id');
            fetch(`/task/toggle/${taskId}`, { 
                method: 'POST'
             })
            .then(response => {
                if(response.ok) {
                    location.reload();
                } else {
                    alert('Failed to update task status.');
                }
            });
          });
        });

        document.querySelectorAll('a[data-task-id]').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const taskId = link.getAttribute('data-task-id');
            window.location.href = `/task/create_subtask/${taskId}`; 
          });
        });
      });
    </script>
  </body>
</html>