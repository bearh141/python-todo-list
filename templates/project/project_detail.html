{% extends "base.html" %}

{% block title %}{{ project.title }}{% endblock %}

{% block content %}
{% macro render_task(task, project_id, level=0, role='owner') %}
  {% set deadline = task.due_date.date() if task.due_date else None %}
  {% set today = now.date() %}
  {% set days_diff = (deadline - today).days if deadline else 999 %}
  {% set sub_count = task.subtasks_list|length if task.subtasks_list else 0 %}

  {# Hiệu ứng màu nền #}
  {% set bg_color = 'bg-white' %}
  {% if task.completed %}
    {% set bg_color = 'bg-green-50' %}
  {% elif deadline and days_diff < 0 %}
    {% set bg_color = 'bg-red-50' %}
  {% endif %}

  <div onclick="toggleSubtasks('subtasks-{{ task.id }}', this)" 
       class="{{ 'ml-' ~ (level * 4) if level > 0 else '' }} mb-4 rounded-lg {{ bg_color }} border border-gray-300 shadow-md hover:shadow-lg p-4 transition-all duration-300 cursor-pointer">

    <div class="flex justify-between items-center">
      <h3 class="text-lg font-semibold text-gray-800 flex items-center
                 {% if task.completed %}line-through text-gray-500{% endif %}">
        {{ task.title }}
        {% if sub_count > 0 %}
          <span class="ml-2 text-sm text-blue-600">({{ sub_count }} subtask{{ 's' if sub_count > 1 else '' }})</span>
          <span class="ml-2 text-blue-500 toggle-icon">[+]</span>
        {% endif %}
      </h3>

      {% if role != 'viewer' %}
        <form action="{{ url_for('task.toggle_complete', task_id=task.id) }}" 
              method="POST" 
              onsubmit="event.stopPropagation(); return confirm('Update status for this task? This will affect subtasks too.');">
          <button type="submit"
                  onclick="event.stopPropagation()"
                  class="px-3 py-1 rounded-full text-sm font-medium transition-colors
                  {% if task.completed %}
                    bg-green-500 text-white hover:bg-green-600
                  {% else %}
                    bg-gray-300 text-gray-800 hover:bg-gray-400
                  {% endif %}">
            {% if task.completed %}✓ Completed{% else %}Mark Complete{% endif %}
          </button>
        </form>
      {% endif %}
    </div>

    <div class="mt-2 text-sm text-gray-600">
      <span class="inline-block px-2 py-1 rounded bg-gray-200 mr-2">{{ task.priority|capitalize }}</span>
      {% for tag in task.tags %}
        <span class="inline-block px-2 py-1 rounded bg-blue-100 text-blue-800 mr-2">{{ tag.name }}</span>
      {% endfor %}
    </div>

    <p class="mt-2 text-gray-700 {% if task.completed %}line-through text-gray-400{% endif %}">
      {{ task.description }}
    </p>

    {% if task.due_date %}
      <p class="mt-2 text-sm text-gray-500">
        Due: {{ task.due_date.strftime('%Y-%m-%d') }}
        {% if not task.completed %}
          {% if days_diff < 0 %}<span class="text-red-500">(Overdue)</span>
          {% elif days_diff == 0 %}<span class="text-yellow-500">(Today)</span>
          {% elif days_diff == 1 %}<span class="text-yellow-400">(Tomorrow)</span>
          {% elif days_diff < 7 %}<span class="text-yellow-300">(In {{ days_diff }} days)</span>
          {% endif %}
        {% endif %}
      </p>
    {% endif %}

    {% if role != 'viewer' %}
      <div class="mt-4 flex space-x-2">
        <a href="{{ url_for('task.edit_task', task_id=task.id) }}" 
           class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
           onclick="event.stopPropagation()">Edit</a>

        <form action="{{ url_for('task.delete_task', task_id=task.id) }}" method="POST" 
              onsubmit="event.stopPropagation(); return confirm('Are you sure you want to delete this task?');">
          <button type="submit" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Delete</button>
        </form>

        {% if level == 0 %}
          <a href="{{ url_for('task.create_subtask', task_id=task.id) }}" 
             class="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600"
             onclick="event.stopPropagation()">Add Sub-task</a>
        {% endif %}
      </div>
    {% endif %}

    {% if sub_count > 0 %}
      <div id="subtasks-{{ task.id }}" class="mt-4 hidden">
        {% for subtask in task.subtasks_list %}
          {{ render_task(subtask, project_id, level + 1, role) }}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endmacro %}

<script>
  function toggleSubtasks(id, el) {
    const element = document.getElementById(id);
    if (!element) return;
    element.classList.toggle('hidden');
    const icon = el.querySelector('.toggle-icon');
    if (icon) icon.textContent = element.classList.contains('hidden') ? '[+]' : '[-]';
  }

  function toggleAddTaskForm() {
    const form = document.getElementById("add-task-form");
    form.classList.toggle("hidden");
  }
</script>

<div class="container mx-auto p-6">
  <div class="flex items-center mb-6 relative">
    <a href="{{ url_for('project.dashboard') }}" 
       class="absolute left-0 text-blue-500 hover:underline">
       Back to Projects
    </a>
    <h1 class="text-2xl font-bold mx-auto">{{ project.title }}</h1>
  </div>

  {% if role != 'viewer' %}
    <div class="flex space-x-4 mb-6">
      <a href="{{ url_for('project.edit_project', project_id=project.id) }}" 
         class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Edit Project</a>
      <form action="{{ url_for('project.delete_project', project_id=project.id) }}" method="POST" 
            onsubmit="return confirm('Are you sure you want to delete this project?');">
        <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Delete Project</button>
      </form>
      {% if session.get('is_admin') or session['user_id'] == project.owner_id %}
        <a href="{{ url_for('project.invite_user', project_id=project.id) }}" 
           class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Invite User</a>
        <a href="{{ url_for('project.export_project', project_id=project.id) }}" 
           class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">Export CSV</a>
      {% endif %}
    </div>
  {% endif %}

  <p class="mb-6 text-gray-700">{{ project.description }}</p>

  {% if role != 'viewer' %}
    <div class="mb-6">
      <button onclick="toggleAddTaskForm()" 
              class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
        Add Task
      </button>
      <div id="add-task-form" class="hidden mt-4">
        <h2 class="text-xl font-semibold mb-4">Add New Task</h2>
        <form action="{{ url_for('task.create_task', project_id=project.id) }}" method="POST" class="space-y-4">
          <div>
            <label for="title">Title</label>
            <input type="text" name="title" id="title" required class="w-full p-2 border rounded">
          </div>
          <div>
            <label for="description">Description</label>
            <textarea name="description" id="description" class="w-full p-2 border rounded"></textarea>
          </div>
          <div>
            <label for="due_date">Due Date</label>
            <input type="date" name="due_date" id="due_date" class="w-full p-2 border rounded">
          </div>
          <div>
            <label for="priority">Priority</label>
            <select name="priority" id="priority" class="w-full p-2 border rounded">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div>
            <label for="tags">Tags (comma-separated)</label>
            <input type="text" name="tags" id="tags" class="w-full p-2 border rounded">
          </div>
          <div class="flex space-x-2">
            <button type="button" onclick="toggleAddTaskForm()" 
                    class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
              Cancel
            </button>
            <button type="submit" 
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
              Add Task
            </button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  <h2 class="text-xl font-semibold mb-4">Tasks</h2>
  {% if tasks %}
    {% for task in tasks %}
      {{ render_task(task, project.id, 0, role) }}
    {% endfor %}
  {% else %}
    <p class="text-gray-500">This project has no tasks yet. Add one above to get started!</p>
  {% endif %}
</div>
{% endblock %}
